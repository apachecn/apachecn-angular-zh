# *ç¬¬ 6 ç« *ï¼šNgRx çš„æ— åŠŸçŠ¶æ€ç®¡ç†

è§’åº¦ç¼–ç¨‹å’Œååº”å¼ç¼–ç¨‹æ˜¯æœ€å¥½çš„æœ‹å‹ï¼Œååº”å¼å¤„ç†åº”ç”¨ç¨‹åºçš„çŠ¶æ€æ˜¯åº”ç”¨ç¨‹åºå¯ä»¥åšçš„æœ€å¥½çš„äº‹æƒ…ä¹‹ä¸€ã€‚NgRx æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€ç»„åº“ä½œä¸º Angular çš„è¢«åŠ¨æ‰©å±•ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ NgRx ç”Ÿæ€ç³»ç»Ÿä»¥ååº”æ–¹å¼ç®¡ç†åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå¹¶ä¸”æ‚¨è¿˜å°†å­¦ä¹  NgRx ç”Ÿæ€ç³»ç»Ÿå°†å¸®åŠ©æ‚¨å®Œæˆçš„ä¸€äº›å¾ˆé…·çš„äº‹æƒ…ã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†åœ¨æœ¬ç« ä¸­ä»‹ç»çš„é£Ÿè°±ï¼š

*   ä½¿ç”¨ actions å’Œ reducer åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª NgRx å­˜å‚¨
*   ä½¿ç”¨`@ngrx/store-devtools`è°ƒè¯•çŠ¶æ€å˜åŒ–
*   åˆ›å»ºè·å–ç¬¬ä¸‰æ–¹**åº”ç”¨ç¼–ç¨‹æ¥å£**ï¼ˆ**API**æ•°æ®çš„æ•ˆæœ
*   ä½¿ç”¨é€‰æ‹©å™¨ä»å¤šä¸ªç»„ä»¶ä¸­çš„å­˜å‚¨ä¸­è·å–æ•°æ®
*   ä½¿ç”¨`@ngrx/component-store`è¿›è¡Œç»„ä»¶å†…çš„æœ¬åœ°çŠ¶æ€ç®¡ç†
*   åˆ©ç”¨`@ngrx/router-store`æ”¹å˜å·¥ä½œè·¯çº¿

# æŠ€æœ¯è¦æ±‚

å¯¹äºæœ¬ç« ä¸­çš„é…æ–¹ï¼Œè¯·ç¡®ä¿æ‚¨çš„æœºå™¨ä¸Šå®‰è£…äº†**Git**å’Œ**Node.js**ã€‚æ‚¨è¿˜éœ€è¦å®‰è£…`@angular/cli`è½¯ä»¶åŒ…ï¼Œæ‚¨å¯ä»¥ä»ç»ˆç«¯ä½¿ç”¨`npm install -g @angular/cli`è¿›è¡Œå®‰è£…ã€‚æœ‰å…³æœ¬ç« çš„ä»£ç ï¼Œè¯·è®¿é—® https://github.com/PacktPublishing/Angular-Cookbook/tree/master/chapter06.

# ä½¿ç”¨ actions å’Œ reducer åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª NgRx å•†åº—

åœ¨æœ¬é£Ÿè°±ä¸­ï¼Œæ‚¨å°†é€šè¿‡å»ºç«‹ç¬¬ä¸€å®¶ NgRx å•†åº—æ¥äº†è§£ NgRx çš„åŸºæœ¬çŸ¥è¯†ã€‚æ‚¨è¿˜å°†åˆ›å»ºä¸€äº›æ“ä½œä»¥åŠä¸€ä¸ªå‡é€Ÿæœºï¼Œä¸ºäº†æŸ¥çœ‹å‡é€Ÿæœºä¸­çš„æ›´æ”¹ï¼Œæˆ‘ä»¬å°†æ”¾å…¥ç›¸åº”çš„æ§åˆ¶å°æ—¥å¿—ä¸­ã€‚

## å‡†å¤‡å¥½äº†å—

æˆ‘ä»¬å°†è¦å¤„ç†çš„é¡¹ç›®ä½äº`chapter06/start_here/ngrx-actions-reducer`ä¸­ï¼Œä½äºå…‹éš†çš„å¯„å­˜å™¨å†…ï¼š

1.  åœ¨**Visual Studio ä»£ç **ï¼ˆ**VS ä»£ç **ä¸­æ‰“å¼€é¡¹ç›®ï¼‰ã€‚
2.  æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œ`npm install`å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
3.  å®Œæˆåï¼Œè¿è¡Œ`ng serve -o`ã€‚

è¿™å°†åœ¨æ–°çš„æµè§ˆå™¨é€‰é¡¹å¡ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºã€‚ç‚¹å‡»**ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•**æŒ‰é’®ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥ä¸‹å±å¹•ï¼š

![Figure 6.1 â€“ ngrx-actions-reducers app running on http://localhost:4200 ](img/Figure_6.1_B15150.jpg)

å›¾ 6.1â€“è¿è¡Œåœ¨ä¸Šçš„ ngrx è¡ŒåŠ¨å‡é€Ÿå™¨åº”ç”¨ç¨‹åº http://localhost:4200

ç°åœ¨æˆ‘ä»¬å·²ç»è¿è¡Œäº†åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ç»§ç»­è¿›è¡Œé…æ–¹çš„æ­¥éª¤ã€‚

## æ€ä¹ˆåšâ€¦

æˆ‘ä»¬æœ‰ä¸€ä¸ªç°æœ‰çš„ Angular åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰çš„é…æ–¹ä¸­ä¹Ÿä½¿ç”¨è¿‡ã€‚å¦‚æœæ‚¨ä»¥ç®¡ç†å‘˜ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œæ‚¨å¯ä»¥åœ¨ bucket ä¸­æ·»åŠ å’Œåˆ é™¤é¡¹ç›®ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä»¥å‘˜å·¥èº«ä»½ç™»å½•ï¼Œåˆ™åªèƒ½æ·»åŠ é¡¹ç›®ï¼Œä¸èƒ½åˆ é™¤é¡¹ç›®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†å¼€å§‹å°† NgRx é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå‡é€Ÿæœºå’Œä¸€äº›æ“ä½œï¼š

1.  Begin by installing the `@ngrx/store package` via **Node Package Manager** (**npm**) in your project. Open Terminal (Mac/Linux) or Command Prompt (Windows), navigate to the project root, and run the following command:

    ```ts
    npm install @ngrx/store@12.0.0 --save
    ```

    å¦‚æœå·²ç»è¿è¡Œäº†`ng-serve`å‘½ä»¤ï¼Œè¯·ç¡®ä¿é‡æ–°è¿è¡Œè¯¥å‘½ä»¤ã€‚

2.  Update the `app.module.ts` file to include `StoreModule`, as follows:

    ```ts
    ...
    import { StoreModule } from '@ngrx/store';
    @NgModule({
      declarations: [
        AppComponent
      ],
      imports: [
        BrowserModule,
        AppRoutingModule,
        FormsModule,
        BrowserAnimationsModule,
     StoreModule.forRoot({})
      ],
      providers: [],
      bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

    æ³¨æ„ï¼Œæˆ‘ä»¬å·²ç»å°†ä¸€ä¸ªç©ºå¯¹è±¡`{}`ä¼ é€’ç»™äº†`forRoot`æ–¹æ³•ï¼›æˆ‘ä»¬å°†ç»§ç»­æ”¹å˜è¿™ä¸€ç‚¹ã€‚

3.  Now, we'll create some actions. Create a folder named `store` inside the `app` folder. Then, create a file named `app.actions.ts` inside the `store` folder, and finally, add the following code to the newly created file:

    ```ts
    import { createAction, props } from '@ngrx/store';
    import { IFruit } from '../interfaces/fruit.interface';
    export const addItemToBucket = createAction(
     '[Bucket] Add Item',
     props<IFruit>()
    );
    export const removeItemFromBucket = createAction(
     '[Bucket] Remove Item',
     props<IFruit>()
    );
    ```

    æ—¢ç„¶æˆ‘ä»¬ç°åœ¨å·²ç»å‡†å¤‡å¥½äº†åŠ¨ä½œï¼Œæˆ‘ä»¬å°±å¿…é¡»åˆ›å»ºä¸€ä¸ªå‡é€Ÿå™¨ã€‚

4.  åœ¨`store`æ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå°†å…¶å‘½åä¸º`app.reducer.ts`ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç æ¥å®šä¹‰å¿…è¦çš„å¯¼å…¥ï¼š

    ```ts
    import { Action, createReducer, on } from '@ngrx/store';
    import { IFruit } from '../interfaces/fruit.interface';
    import * as AppActions from './app.actions';
    ```

5.  ç°åœ¨ï¼Œå®šä¹‰ä¸€ä¸ª`AppState`æ¥å£æ¥åæ˜ åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå®šä¹‰ä¸€ä¸ª`initialState`å˜é‡æ¥åæ˜ åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶çš„çŠ¶æ€ã€‚åœ¨`app.reducer.ts`æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

    ```ts
    import { Action, createReducer, on } from '@ngrx/store';
    import { IFruit } from '../interfaces/fruit.interface';
    import * as AppActions from './app.actions';

    export interface AppState {
     bucket: IFruit[];
    }

    const initialState: AppState = {
     bucket: []
    }
    ```

6.  ç°åœ¨æ˜¯å®é™…åˆ›å»ºå‡é€Ÿå™¨çš„æ—¶å€™äº†ã€‚åœ¨`app.reducer.ts`æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ä»¥åˆ›å»ºå‡é€Ÿæœºï¼š

    ```ts
    ...
    const initialState: AppState = {
      bucket: []
    }
    const appReducer = createReducer(
     initialState,
     on(AppActions.addItemToBucket, (state, fruit) =>   ({ ...state, bucket: [fruit, ...state.bucket] })),
     on(AppActions.removeItemFromBucket, (state, fruit) => {
     return {
     ...state,
     bucket: state.bucket.filter(bucketItem => {
     return bucketItem.id !== fruit.id;
     }) }
     }),
    );

    export function reducer(state: AppState = initialState, action: Action) {
     return appReducer(state, action);
    }
    ```

7.  æˆ‘ä»¬è¿˜å°†åœ¨`reducer`æ–¹æ³•ä¸­æ·»åŠ ä¸€äº›å¯çˆ±çš„å°`console.logs`è°ƒç”¨ï¼Œä»¥æŸ¥çœ‹æ‰€æœ‰åŠ¨ä½œåœ¨æ§åˆ¶å°ä¸Šå¯åŠ¨ã€‚åœ¨`app.reducer.ts`æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹æ—¥å¿—ï¼š

    ```ts
    export function reducer(state: AppState = initialState, action: Action) {
      console.log('state', state);
     console.log('action', action);
      return appReducer(state, action);
    }
    ```

8.  Finally, let's register this reducer in the `app.module.ts` file using the `StoreModule.forRoot()` method as follows so that we can see things working:

    ```ts
    ...
    import { StoreModule } from '@ngrx/store';
    import * as appStore from './store/app.reducer';
    @NgModule({
      declarations: [
        AppComponent
      ],
      imports: [
        ...
        StoreModule.forRoot({app: appStore.reducer})
      ],
      providers: [],
      bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

    å¦‚æœæ‚¨ç°åœ¨åˆ·æ–°åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨ååº”ç«‹å³åœ¨æ§åˆ¶å°ä¸Šçœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

    ![Figure 6.2 â€“ Logs showing initial state and @ngrx/store/init action on app start ](img/Figure_6.2_B15150.jpg)

    å›¾ 6.2â€“æ˜¾ç¤ºåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹çŠ¶æ€å’Œ@ngrx/store/init æ“ä½œçš„æ—¥å¿—

9.  ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡é€Ÿæœºå·¥ä½œäº†ï¼Œè®©æˆ‘ä»¬æ¥è°ƒåº¦æ·»åŠ å’Œåˆ é™¤ç¯®å­ä¸­çš„é¡¹ç›®çš„æ“ä½œã€‚ä¸ºæ­¤ï¼Œåœ¨`shared/components/bucket`/`bucket.component.ts`æ–‡ä»¶ä¸­å‘é€å¦‚ä¸‹æ“ä½œï¼š

    ```ts
    ...
    import { Store } from '@ngrx/store';
    import { AppState } from 'src/app/store/app.reducer';
    import { addItemToBucket, removeItemFromBucket } from 'src/app/store/app.actions';
    export class BucketComponent implements OnInit {
      ...
      constructor(
        private bucketService: BucketService,
     private store: Store<AppState>
      ) { }
      ngOnInit(): void {...}
      addSelectedFruitToBucket() {
    const newItem: IFruit = {
     id: Date.now(),
     name: this.selectedFruit
     }
        this.bucketService.addItem(newItem);
     this.store.dispatch(addItemToBucket(newItem));
      }
      deleteFromBucket(fruit: IFruit) {
        this.bucketService.removeItem(fruit);
     this.store.dispatch(removeItemFromBucket(fruit));
      }
    }
    ```

10.  ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½• appï¼Œåœ¨ bucket ä¸­æ·»åŠ ä¸€äº›é¡¹ç›®ï¼Œç„¶ååˆ é™¤ä¸€äº›é¡¹ç›®ã€‚æ‚¨å°†åœ¨æ§åˆ¶å°ä¸Šçœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š

![Figure 6.3 â€“ Logs showing the actions for adding and removing items from a bucket ](img/Figure_6.3_B15150.jpg)

å›¾ 6.3â€“æ˜¾ç¤ºä» bucket æ·»åŠ å’Œåˆ é™¤é¡¹ç›®çš„æ“ä½œçš„æ—¥å¿—

è¿™å°±æ˜¯è¿™ä¸ªé£Ÿè°±çš„å…¨éƒ¨å†…å®¹ï¼æ‚¨ç°åœ¨çŸ¥é“å¦‚ä½•å°† NgRx åº”ç”¨å•†åº—é›†æˆåˆ° Angular åº”ç”¨ç¨‹åºä¸­ï¼Œä»¥åŠå¦‚ä½•åˆ›å»º NgRx æ“ä½œå¹¶è°ƒåº¦å®ƒä»¬ã€‚æ‚¨è¿˜çŸ¥é“å¦‚ä½•åˆ›å»ºå‡é€Ÿå™¨ã€å®šä¹‰å…¶çŠ¶æ€ï¼Œä»¥åŠå¦‚ä½•ä¾¦å¬å¯¹å·²è°ƒåº¦çš„å‡é€Ÿå™¨æ‰§è¡Œçš„æ“ä½œã€‚

## å¦è§

*   NgRx å‡é€Ÿå™¨æ–‡ä»¶ï¼ˆ[https://ngrx.io/guide/store/reducers](https://ngrx.io/guide/store/reducers)
*   NgRxè¡ŒåŠ¨æ–‡ä»¶ï¼ˆ[https://ngrx.io/guide/store/actions](https://ngrx.io/guide/store/actions)
*   RxJS åˆå¹¶è¿ç®—ç¬¦æ–‡æ¡£ï¼ˆ[https://www.learnrxjs.io/learn-rxjs/operators/combination/merge](https://www.learnrxjs.io/learn-rxjs/operators/combination/merge)

# ä½¿ç”¨@ngrx/store devtools è°ƒè¯•çŠ¶æ€å˜åŒ–

åœ¨æœ¬é£Ÿè°±ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•è®¾ç½®å¹¶ä½¿ç”¨`@ngrx/store-devtools`è°ƒè¯•åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€åŠ¨ä½œè°ƒåº¦ä»¥åŠåŠ¨ä½œè°ƒåº¦æ—¶çŠ¶æ€çš„å·®å¼‚ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬ç†Ÿæ‚‰çš„ç°æœ‰åº”ç”¨ç¨‹åºæ¥äº†è§£æµç¨‹ã€‚

## å‡†å¤‡å¥½äº†å—

æ­¤é…æ–¹çš„é¡¹ç›®ä½äº`chapter06/start_here/using-ngrx-store-devtool`ï¼š

1.  åœ¨ VS ä»£ç ä¸­æ‰“å¼€é¡¹ç›®ã€‚
2.  æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œ`npm install`å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
3.  Once done, run `ng serve -o`.

    è¿™å°†åœ¨æ–°çš„æµè§ˆå™¨é€‰é¡¹å¡ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºã€‚

4.  ä»¥ç®¡ç†å‘˜ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å±å¹•ï¼š

![Figure 6.4 â€“ Using ngrx-store-devtools app running on http://localhost:4200 ](img/Figure_6.4_B15150.jpg)

å›¾ 6.4â€“ä½¿ç”¨è¿è¡Œåœ¨ä¸Šçš„ ngrx store devtools åº”ç”¨ç¨‹åº http://localhost:4200

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½®äº†åº”ç”¨ç¨‹åºï¼Œè®©æˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚ä¸­æŸ¥çœ‹é…æ–¹çš„æ­¥éª¤ã€‚

## æ€ä¹ˆåšâ€¦

æˆ‘ä»¬æœ‰ä¸€ä¸ªè§’åº¦çš„åº”ç”¨ç¨‹åºï¼Œå·²ç»é›†æˆäº†`@ngrx/store`åŒ…ã€‚æˆ‘ä»¬è¿˜è®¾ç½®äº†ä¸€ä¸ªå‡é€Ÿå™¨ï¼Œå¹¶åœ¨æ§åˆ¶å°ä¸Šè®°å½•äº†ä¸€äº›æ“ä½œï¼Œåªè¦æ‚¨æ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªé¡¹ç›®ã€‚è®©æˆ‘ä»¬å¼€å§‹ä¸º ap é…ç½®åº”ç”¨å•†åº—å¼€å‘å·¥å…·ï¼š

1.  æŒ‰ç…§

    ```ts
    npm install @ngrx/store-devtools@12.0.0 --save
    ```

    åŒ…ä¸­çš„`@ngrx/store-devtools`å¼€å§‹å®‰è£…
2.  ç°åœ¨ï¼Œæ›´æ–°æ‚¨çš„`app.module.ts`æ–‡ä»¶ä»¥åŒ…å«`StoreDevtoolsModule.instrument`æ¡ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    import * as appStore from './store/app.reducer';
    import { StoreDevtoolsModule } from '@ngrx/store-devtools';
    @NgModule({
      declarations: [
        AppComponent
      ],
      imports: [
        ...
        StoreModule.forRoot({app: appStore.reducer}),
        StoreDevtoolsModule.instrument({
     maxAge: 25, // Retains last 25 states
     }),
      ],
      providers: [],
      bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

3.  ç°åœ¨ï¼Œä»[ä¸‹è½½ Redux DevTools æ‰©å±• https://github.com/zalmoxisus/redux-devtools-extension/](https://github.com/zalmoxisus/redux-devtools-extension/) ç”¨äºæ‚¨çš„ç‰¹å®šæµè§ˆå™¨å¹¶å®‰è£…å®ƒã€‚åœ¨æœ¬ä¹¦ä¸­ï¼Œæˆ‘å°†å§‹ç»ˆä½¿ç”¨ Chrome æµè§ˆå™¨ã€‚
4.  Open Chrome DevTools. There should be a new tab named **Redux**. Tap it and refresh the page. You'll see something like this:

    ![Figure 6.5 â€“ Redux DevTools showing the initial Redux action dispatched ](img/Figure_6.5_B15150.jpg)

    å›¾ 6.5â€“æ˜¾ç¤ºåˆå§‹ Redux æ“ä½œçš„ Redux å¼€å‘å·¥å…·

5.  To see the state of the app right now, tap the **State** button, as shown in the following screenshot, and you should see that we have `app > bucket: []` as the current state:

    ![Figure 6.6 â€“ Viewing current state in the Redux DevTools extension ](img/Figure_6.6_B15150.jpg)

    å›¾ 6.6â€“åœ¨ Redux DevTools æ‰©å±•ä¸­æŸ¥çœ‹å½“å‰çŠ¶æ€

6.  Now, add a cherry ğŸ’ and a banana ğŸŒ to the bucket, and then remove the banana ğŸŒ from the bucket. You should see all the relevant actions being dispatched, as follows:

![Figure 6.7 â€“ Redux DevTools showing addItemToBucket and removeItemFromBucket actions ](img/Figure_6.7_B15150.jpg)

å›¾ 6.7â€“æ˜¾ç¤º addItemToBucket å’Œ removeItemFromBucket æ“ä½œçš„ Redux å¼€å‘å·¥å…·

å¦‚æœæ‚¨ä»çŠ¶æ€å±•å¼€ bucketæ•°ç»„ï¼Œæ‚¨å°†çœ‹åˆ°å®ƒåæ˜ äº† bucket çš„å½“å‰çŠ¶æ€ï¼Œå¦‚ä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºï¼š

![Figure 6.8 â€“ Redux DevTools showing bucket's current state ](img/Figure_6.8_B15150.jpg)

å›¾ 6.8â€“æ˜¾ç¤º bucket å½“å‰çŠ¶æ€çš„ Redux DevTools

ä¼Ÿå¤§çš„æ‚¨åˆšåˆšäº†è§£äº†å¦‚ä½•ä½¿ç”¨ Redux DevTools æ‰©å±•æŸ¥çœ‹ NgRx çŠ¶æ€å’Œæ­£åœ¨è°ƒåº¦çš„æ“ä½œã€‚

## å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„â€¦

äº†è§£ NgRx æ˜¯è§’åº¦å’Œé‡å¤é¢‘ç‡çš„ç»„åˆï¼ˆä½¿ç”¨ RxJSï¼‰éå¸¸é‡è¦ã€‚é€šè¿‡ä½¿ç”¨ Store Devtools è½¯ä»¶åŒ…å’Œ Redux Devtools æ‰©å±•ï¼Œæˆ‘ä»¬èƒ½å¤Ÿéå¸¸è½»æ¾åœ°è°ƒè¯•åº”ç”¨ç¨‹åºï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬å‘ç°æ½œåœ¨çš„ bugï¼Œé¢„æµ‹çŠ¶æ€å˜åŒ–ï¼Œå¹¶æ›´åŠ é€æ˜åœ°äº†è§£`@ngrx/store`è½¯ä»¶åŒ…ä¸­å¹•åå‘ç”Ÿçš„äº‹æƒ…ã€‚

## è¿˜æœ‰æ›´å¤šâ€¦

æ‚¨è¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåŠ¨ä½œåœ¨åº”ç”¨ç¨‹åºçŠ¶æ€ä¸­å¼•èµ·çš„å·®å¼‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬å‘é€å¸¦æœ‰æ°´æœçš„`addItemToBucket`åŠ¨ä½œæ—¶ï¼Œæˆ‘ä»¬åœ¨æ¡¶ä¸­æ·»åŠ äº†ä¸€ä¸ªé¡¹ç›®ï¼Œå½“æˆ‘ä»¬å‘é€`removeItemFromBucket`åŠ¨ä½œæ—¶ï¼Œæˆ‘ä»¬ä»æ¡¶ä¸­ç§»é™¤äº†ä¸€ä¸ªé¡¹ç›®ã€‚æ¯ç§æƒ…å†µè§ä»¥ä¸‹æˆªå›¾å’Œ*å›¾ 6.10*ï¼š

![Figure 6.9 â€“ addItemToBucket action causing the addition of an item to the bucket ](img/Figure_6.9_B15150.jpg)

å›¾ 6.9â€“addItemToBucket æ“ä½œå¯¼è‡´å°†ç‰©å“æ·»åŠ åˆ°æ¡¶ä¸­

æ³¨æ„*å›¾ 6.9*ä¸­æ•°æ®`{id:1605205728586,name:'Banana` `ğŸŒ``'}`å‘¨å›´çš„ç»¿è‰²èƒŒæ™¯ã€‚è¿™è¡¨ç¤ºè¯¥çŠ¶æ€å¢åŠ äº†ä¸€ä¸ªã€‚æ‚¨å¯ä»¥çœ‹åˆ°æ­¤å¤„æè¿°çš„`removeItemFromBucket`åŠ¨ä½œï¼š

![Figure 6.10 â€“ removeItemFromBucket action causing the removal of an item from the bucket ](img/Figure_6.10_B15150.jpg)

å›¾ 6.10â€“ä»é“²æ–—ä¸­ç§»é™¤é¡¹ç›®çš„ removeItemFromBucket åŠ¨ä½œ

åŒæ ·ï¼Œè¯·æ³¨æ„*å›¾ 6.10*ä¸­æ•°æ®`{id:16052057285â€¦` `ğŸŒ``'}`å‘¨å›´çš„çº¢è‰²èƒŒæ™¯å’Œåˆ é™¤çº¿ã€‚è¿™è¡¨ç¤ºä»çŠ¶æ€ä¸­åˆ é™¤ã€‚

## å¦è§

*   NgRx å­˜å‚¨è®¾å¤‡æ–‡æ¡£ï¼ˆ[https://ngrx.io/guide/store-devtools](https://ngrx.io/guide/store-devtools)

# åˆ›å»ºè·å–ç¬¬ä¸‰æ–¹ API æ•°æ®çš„æ•ˆæœ

åœ¨æœ¬é£Ÿè°±ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨`@ngrx/effects`è½¯ä»¶åŒ…ä½¿ç”¨ NgRx æ•ˆæœã€‚æ‚¨å°†åˆ›å»ºå¹¶æ³¨å†Œä¸€ä¸ªæ•ˆæœï¼Œè¯¥æ•ˆæœå°†ç›‘å¬äº‹ä»¶ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†å¯¹è¯¥æ“ä½œä½œå‡ºååº”ä»¥è·å–ç¬¬ä¸‰æ–¹ API æ•°æ®ï¼Œä½œä¸ºå“åº”ï¼Œæˆ‘ä»¬å°†è°ƒåº¦æˆåŠŸæˆ–å¤±è´¥æ“ä½œã€‚è¿™ä¼šå¾ˆæœ‰è¶£çš„ã€‚

## å‡†å¤‡å¥½äº†å—

è¯¥é…æ–¹çš„é¡¹ç›®ä½äº`chapter06/start_here/using-ngrx-effect`ï¼š

1.  åœ¨ VS ä»£ç ä¸­æ‰“å¼€é¡¹ç›®ã€‚
2.  æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œ`npm install`å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
3.  Once done, run `ng serve -o`.

    è¿™å°†åœ¨æ–°çš„æµè§ˆå™¨é€‰é¡¹å¡ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºï¼Œæ‚¨å°†çœ‹åˆ°è¯¥åº”ç”¨ç¨‹åºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![Figure 6.11 â€“ Using ngrx-effects app running on http://localhost:4200 ](img/Figure_6.11_B15150.jpg)

å›¾ 6.11â€“ä½¿ç”¨è¿è¡Œåœ¨ä¸Šçš„ ngrx effects åº”ç”¨ç¨‹åº http://localhost:4200

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æœ¬åœ°è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè®©æˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚ä¸­æŸ¥çœ‹é…æ–¹çš„æ­¥éª¤ã€‚

## æ€ä¹ˆåšâ€¦

æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º**ä¸»é¡µ**é¡µé¢çš„å•ä¸€è·¯çº¿åº”ç”¨ç¨‹åºã€‚åœ¨`HomeComponent`ç±»ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`UserService`å‘é€**è¶…æ–‡æœ¬ä¼ è¾“åè®®**ï¼ˆ**HTTP**ï¼‰è°ƒç”¨ä»¥è·å–ç”¨æˆ·ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸Šæ˜¾ç¤ºã€‚æˆ‘ä»¬å·²ç»é›†æˆäº†`@ngrx/store`å’Œ`@ngrx/store-devtools`åŒ…ï¼Œå¦‚*å›¾ 6.1*æ‰€ç¤ºï¼š

1.  åœ¨é¡¹ç›®ä¸­å®‰è£…`@ngrx/effects`åŒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    npm install --save @ngrx/effects@12.0.0
    ```

2.  We'll now create actions to get the users from the HTTP call. We'll have one action to get the users, one to dispatch on successfully getting the users, and one action to dispatch in case we get an error. Add the following code to the `store/app.actions.ts` file:

    ```ts
    import { createAction, props } from '@ngrx/store';
    import { IUser } from '../core/interfaces/user.interface';
    export const APP_ACTIONS = {
     GET_USERS: '[Users] Get Users',
     GET_USERS_SUCCESS: '[Users] Get Users Success',
     GET_USERS_FAILURE: '[Users] Get Users Failure',
    }
    export const getUsers = createAction(
     APP_ACTIONS.GET_USERS,
    );
    export const getUsersSuccess = createAction(
     APP_ACTIONS.GET_USERS_SUCCESS,
     props<{users: IUser[]}>()
    );
    export const getUsersFailure = createAction(
     APP_ACTIONS.GET_USERS_FAILURE,
     props<{error: string}>()
    );
    ```

    ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ•ˆæœï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›‘å¬`GET_USERS`æ“ä½œï¼Œæ‰§è¡Œ API è°ƒç”¨ï¼Œå¹¶åœ¨æˆåŠŸè·å–æ•°æ®çš„æƒ…å†µä¸‹å‘é€æˆåŠŸæ“ä½œã€‚

3.  åœ¨åä¸º`app.effects.ts`çš„`store`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

    ```ts
    import { Injectable } from '@angular/core';
    import { Actions, createEffect, ofType } from '@ngrx/effects';
    import { of } from 'rxjs';
    import { map, mergeMap, catchError } from 'rxjs/operators';
    import { UserService } from '../core/services/user.service';
    import { APP_ACTIONS, getUsersFailure, getUsersSuccess } from './app.actions';
    @Injectable()
    export class AppEffects {
     constructor(
     private actions$: Actions,
     private userService: UserService
     ) {}
    }
    ```

4.  æˆ‘ä»¬ç°åœ¨åœ¨`app.effects.ts`æ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ•ˆæœï¼Œä¸º`GET_USERS`åŠ¨ä½œæ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼Œå¦‚ä¸‹ï¼š

    ```ts
    ...
    @Injectable()
    export class AppEffects {
      getUsers$ = createEffect(() =>
        this.actions$.pipe(
          ofType(APP_ACTIONS.GET_USERS),
          mergeMap(() => this.userService.getUsers()
            .pipe(
              map(users => {
                return getUsersSuccess({
                  users
                })
              }),
              catchError((error) => of(getUsersFailure({
                error
              })))
            )
          )
        )
      );
      ...
    }
    ```

5.  We'll now register our effect as the root effects for the app in the `app.module.ts` file, as follows:

    ```ts
    ...
    import { EffectsModule } from '@ngrx/effects';
    import { AppEffects } from './store/app.effects';
    @NgModule({
      declarations: [...],
      imports: [
        ...
        StoreDevtoolsModule.instrument({
          maxAge: 25, // Retains last 25 states
        }),
     EffectsModule.forRoot([AppEffects])
      ],
      providers: [],
      bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

    ä¸€æ—¦æˆ‘ä»¬æ³¨å†Œäº†æ•ˆæœï¼Œæ‚¨å°±ä¼šåœ¨ Redux DevTools æ‰©å±•ä¸­çœ‹åˆ°ä¸€ä¸ªåä¸º`@ngrx/effects/init`çš„é¢å¤–æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ![Figure 6.12 â€“ @ngrx/effects/init action fired on app launch ](img/Figure_6.12_B15150.jpg)

    å›¾ 6.12â€“@ngrx/effects/init æ“ä½œåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å¯åŠ¨

6.  Now that we have the effects listening to the actions, let's dispatch the `GET_USERS` action from the `HomeComponent` class, and we should see the `GET_USERS_SUCCESS` action fired in return on the successful call fetch. Add the following code to dispatch the action from `home/home.component.ts`:

    ```ts
    ...
    import { AppState } from '../store/app.reducer';
    import { Store } from '@ngrx/store';
    import { getUsers } from '../store/app.actions';
    @Component({...})
    export class HomeComponent implements OnInit, OnDestroy {
      users$: Observable<IUser[]>;
      constructor(
        private userService: UserService,
     private store: Store<AppState>
      ) {}
      ngOnInit() {
        this.store.dispatch(getUsers())
        this.users$ = this.userService.getUsers();
      }
      ngOnDestroy() {}
    }
    ```

    å¦‚æœä½ ç°åœ¨åˆ·æ–°åº”ç”¨ç¨‹åºï¼Œä½ åº”è¯¥çœ‹åˆ°`[Users] Get Users`åŠ¨ä½œè¢«è°ƒåº¦ï¼Œä½œä¸ºå›æŠ¥ï¼Œ`[Users] Get Users Success`åŠ¨ä½œåœ¨æˆåŠŸçš„ HTTP è°ƒç”¨ä¸Šè¢«è°ƒåº¦ï¼š

    ![Figure 6.13 â€“ GET_USERS and GET_USERS_SUCCESS actions being dispatched ](img/Figure_6.13_B15150.jpg)

    å›¾ 6.13â€“æ­£åœ¨è°ƒåº¦çš„ GET_ ç”¨æˆ·å’Œ GET_ ç”¨æˆ·æˆåŠŸæ“ä½œ

    æ³¨æ„*å›¾ 6.13*ä¸­`GET_USERS_SUCCESS`åŠ¨ä½œå‘å‡ºå`Diff`ä¸ºç©ºã€‚è¿™æ˜¯å› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨ reducer æ›´æ–°çŠ¶æ€ã€‚

7.  Let's update the state in the `app.reducer.ts` file to listen to the `GET_USERS_SUCCESS` action and assign the users to the state accordingly. The code should look like this:

    ```ts
    import { Action, createReducer, on } from '@ngrx/store';
    import { IUser } from '../core/interfaces/user.interface';
    import { getUsersSuccess } from './app.actions';
    export interface AppState {
      users: IUser[];
    }
    const initialState: AppState = {
      users: []
    }
    const appReducer = createReducer(
      initialState,
     on(getUsersSuccess, (state, action) => ({
     ...state,
     users: action.users
     }))
    );
    export function reducer(state: AppState = initialState, action: Action) {
      return appReducer(state, action);
    }
    ```

    å¦‚æœæ‚¨ç°åœ¨åˆ·æ–° appï¼Œæ‚¨åº”è¯¥çœ‹åˆ°è¢«åˆ†é…åˆ°è¯¥çŠ¶æ€çš„ç”¨æˆ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ![Figure 6.14 â€“ GET_USERS_SUCCESS action adding users to the state ](img/Figure_6.14_B15150.jpg)

    å›¾ 6.14â€“GET_USERS_SUCCESS æ“ä½œå°†ç”¨æˆ·æ·»åŠ åˆ°çŠ¶æ€

    å¦‚æœæ‚¨ç°åœ¨æŸ¥çœ‹åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š

    ![Figure 6.15 â€“ App state containing users after the GET_USERS_SUCCESS action ](img/Figure_6.15_B15150.jpg)

    å›¾ 6.15â€“GET_users_SUCCESS æ“ä½œååŒ…å«ç”¨æˆ·çš„åº”ç”¨ç¨‹åºçŠ¶æ€

    ç°åœ¨ï¼Œæˆ‘ä»¬æ­£åœ¨å‘æœåŠ¡å™¨å‘é€ä¸¤ä¸ªè°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡ effectï¼Œå¦ä¸€ä¸ªæ˜¯é€šè¿‡ç›´æ¥ä½¿ç”¨`UserService`å®ä¾‹çš„`HomeComponent`ç±»çš„`ngOnInit`æ–¹æ³•ã€‚è®©æˆ‘ä»¬ä»`HomeComponent`ç±»ä¸­åˆ é™¤`UserService`ã€‚æˆ‘ä»¬ç°åœ¨ä¸ä¼šçœ‹åˆ°ä»»ä½•æ•°æ®ï¼Œä½†è¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸‹ä¸€ä¸ªé…æ–¹ä¸­è¦åšçš„ã€‚

8.  ä»`HomeComponent`ç±»ä¸­åˆ é™¤`UserService`ï¼Œæ‚¨çš„`home.component.ts`æ–‡ä»¶ç°åœ¨åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    @Component({...})
    export class HomeComponent implements OnInit, OnDestroy {
      users$: Observable<IUser[]>;
      constructor(
     private userService: UserService, â† Remove this
        private store: Store<AppState>
      ) {}
      ngOnInit() {
        this.store.dispatch(getUsers());
     this.users$ = this.userService.getUsers();  â† Remove     this
      }
      ngOnDestroy() {}
    }
    ```

ä¼Ÿå¤§çš„ä½ ç°åœ¨çŸ¥é“å¦‚ä½•åœ¨ä½ çš„ Angular åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ NgRxæ•ˆæœã€‚è¯·å‚é˜…ä¸‹ä¸€èŠ‚äº†è§£ NgRx æ•ˆæœçš„å·¥ä½œåŸç†ã€‚

é‡è¦æç¤º

æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªè¾“å‡ºï¼Œå¦‚å›¾ 6.15*æ‰€ç¤º*â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿åœ¨å­˜å‚¨ä¸­è®¾ç½®äº†ç”¨æˆ·æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿä¼šç»§ç»­æ˜¾ç¤ºåŠ è½½å™¨ã€‚é£Ÿè°±çš„ä¸»è¦ç›®çš„æ˜¯ä½¿ç”¨`@ngrx/effects`ï¼Œè¿™å·²ç»å®Œæˆã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ä¸ªé…æ–¹ä¸­æ˜¾ç¤ºé€‚å½“çš„æ•°æ®ï¼Œ*ä½¿ç”¨é€‰æ‹©å™¨ä»å¤šä¸ªç»„ä»¶*ä¸­çš„å­˜å‚¨ä¸­è·å–æ•°æ®ã€‚

## å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„â€¦

ä¸ºäº†è®© NgRx ç‰¹æ•ˆå‘æŒ¥ä½œç”¨ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…`@ngrx/effects`åŒ…ï¼Œåˆ›å»ºä¸€ä¸ªç‰¹æ•ˆï¼Œå¹¶å°†å…¶æ³¨å†Œä¸º`AppModule`ç±»ä¸­çš„ç‰¹æ•ˆæ•°ç»„ï¼ˆæ ¹ç‰¹æ•ˆï¼‰ã€‚å½“ä½ åˆ›é€ ä¸€ä¸ªæ•ˆæœæ—¶ï¼Œå®ƒå¿…é¡»å€¾å¬ä¸€ä¸ªåŠ¨ä½œã€‚å½“ä¸€ä¸ªåŠ¨ä½œä»ä»»ä½•ç»„ä»¶æˆ–ç”šè‡³ä»å¦ä¸€ä¸ªæ•ˆæœå‘é€åˆ°å­˜å‚¨æ—¶ï¼Œæ³¨å†Œçš„æ•ˆæœå°†è§¦å‘ï¼Œæ‰§è¡Œæ‚¨å¸Œæœ›å®ƒæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åº”å‘é€å¦ä¸€ä¸ªåŠ¨ä½œä½œä¸ºå›æŠ¥ã€‚å¯¹äº API è°ƒç”¨ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸‰ä¸ªæ“ä½œï¼Œå³ä¸»æ“ä½œå’Œä»¥ä¸‹æˆåŠŸå’Œå¤±è´¥æ“ä½œã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨æˆåŠŸæ“ä½œä¸Šï¼ˆä¹Ÿå¯èƒ½åœ¨å¤±è´¥æ“ä½œä¸Šï¼‰ï¼Œæ‚¨å¸Œæœ›æ›´æ–°ä¸€äº›çŠ¶æ€å˜é‡ã€‚

## å¦è§

*   NgRx æ•ˆåº”æ–‡ä»¶ï¼ˆ[https://ngrx.io/guide/effects](https://ngrx.io/guide/effects)

# ä½¿ç”¨é€‰æ‹©å™¨ä»å¤šä¸ªç»„ä»¶ä¸­çš„å­˜å‚¨ä¸­è·å–æ•°æ®

åœ¨å‰é¢çš„é…æ–¹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªNgRx æ•ˆæœï¼Œä»¥ç”¨æˆ·èº«ä»½è·å–ç¬¬ä¸‰æ–¹ API æ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ Redux å­˜å‚¨ä¸­ã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¿™ä¸ªé£Ÿè°±çš„å‡ºå‘ç‚¹ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªä»`api.randomuser.me`è·å–ç”¨æˆ·å¹¶å°†å…¶å­˜å‚¨åœ¨çŠ¶æ€çš„æ•ˆæœï¼Œæˆ‘ä»¬ç›®å‰åœ¨**ç”¨æˆ·ç•Œé¢**ï¼ˆ**UI**ä¸Šæ²¡æœ‰æ˜¾ç¤ºä»»ä½•å†…å®¹ã€‚åœ¨æ­¤é…æ–¹ä¸­ï¼Œæ‚¨å°†åˆ›å»ºä¸€äº› NgRx é€‰æ‹©å™¨ï¼Œä»¥ä¾¿åœ¨**ä¸»é¡µ**é¡µé¢ä»¥åŠ**ç”¨æˆ·è¯¦ç»†ä¿¡æ¯**é¡µé¢ä¸Šä¸ç±»ä¼¼ç”¨æˆ·ä¸€èµ·æ˜¾ç¤ºç”¨æˆ·ã€‚

## å‡†å¤‡å¥½äº†å—

æ­¤é…æ–¹çš„é¡¹ç›®ä½äº`chapter06/start_here/using-ngrx-selector`ï¼š

1.  åœ¨ VS ä»£ç ä¸­æ‰“å¼€é¡¹ç›®ã€‚
2.  æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œ`npm install`å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
3.  Once done, run `ng serve -o`.

    è¿™å°†åœ¨æ–°çš„æµè§ˆå™¨é€‰é¡¹å¡ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºã€‚é¡µé¢ä¸€æ‰“å¼€ï¼Œæ‚¨å°±ä¼šçœ‹åˆ°åº”ç”¨ç¨‹åºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![Figure 6.16 â€“ Using ngrx-selectors app running on http://localhost:4200 ](img/Figure_6.16_B15150.jpg)

å›¾ 6.16â€“ä½¿ç”¨è¿è¡Œåœ¨ä¸Šçš„ ngrx é€‰æ‹©å™¨åº”ç”¨ç¨‹åº http://localhost:4200

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æœ¬åœ°è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè®©æˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚ä¸­æŸ¥çœ‹é…æ–¹çš„æ­¥éª¤ã€‚

## æ€ä¹ˆåšâ€¦

åœ¨è¿™ä¸ªé…æ–¹ä¸­ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯ä½¿ç”¨ NgRx é€‰æ‹©å™¨ã€æˆ‘ä»¬æ‹¥æœ‰çš„å‡é€Ÿæœºä»¥åŠé€šå¸¸çš„ Redux çŠ¶æ€ã€‚ç®€å•çš„è±Œè±†ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼

æˆ‘ä»¬å°†é¦–å…ˆåœ¨**ä¸»é¡µ**é¡µé¢ä¸Šæ˜¾ç¤ºç”¨æˆ·ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºç¬¬ä¸€ä¸ª NgRx selectoï¼š

1.  Create a new file inside the `store` folder. Name it `app.selectors.ts` and add the following code to it:

    ```ts
    import { createSelector, createFeatureSelector } from '@ngrx/store';
    import { AppState } from './app.reducer';
    export const selectApp = createFeatureSelector<AppState>('app');
    export const selectUsers = createSelector(
      selectApp,
      (state: AppState) => state.users
    );
    ```

    ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†é€‰æ‹©å™¨ï¼Œè®©æˆ‘ä»¬åœ¨`HomeComponent`ç±»ä¸­ä½¿ç”¨å®ƒã€‚

2.  Modify the `ngOnInit` method in the `home.component.ts` file. It should look like this:

    ```ts
    ...
    import { getUsers } from '../store/app.actions';
    import { selectUsers } from '../store/app.selectors';
    @Component({...})
    export class HomeComponent implements OnInit, OnDestroy {
      ...
      ngOnInit() {
        this.users$ = this.store.select(selectUsers);
        this.store.dispatch(getUsers())
      }
      ngOnDestroy() {}
    }
    ```

    ä¸€æ—¦ä½ ç°åœ¨åˆ·æ–°åº”ç”¨ç¨‹åºï¼Œä½ åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ç”¨æˆ·ã€‚å¦‚æœä½ ç‚¹å‡»ä»»ä½•ä¸€ä¸ªç”¨æˆ·ï¼Œä½ å°†å¯¼èˆªåˆ°ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼Œä½†ä¸ä¼šçœ‹åˆ°ä»»ä½•æœ‰ä»·å€¼çš„æ—¥æœŸã€‚é¡µé¢åº”å¦‚ä¸‹æ‰€ç¤ºï¼š

    ![Figure 6.17 â€“ Unable to display the current user and similar users ](img/Figure_6.17_B15150.jpg)

    å›¾ 6.17â€“æ— æ³•æ˜¾ç¤ºå½“å‰ç”¨æˆ·å’Œç±»ä¼¼ç”¨æˆ·

3.  ä¸ºäº†æŸ¥çœ‹å½“å‰ç”¨æˆ·å’Œç±»ä¼¼ç”¨æˆ·ï¼Œæˆ‘ä»¬å°†é¦–å…ˆåœ¨`UserDetailComponent`ç±»ä¸­åˆ›å»ºä¸¤ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œä»¥ä¾¿ç¨åè®¢é˜…å®ƒä»¬å„è‡ªçš„å•†åº—é€‰æ‹©å™¨ã€‚å°†è§‚æµ‹å€¼æ·»åŠ åˆ°`user-detail.component.ts`æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    import { ActivatedRoute } from '@angular/router';
    import { Observable } from 'rxjs/internal/Observable';
    @Component({...})
    export class UserDetailComponent implements OnInit, OnDestroy {
     user: IUser = null; â† Remove this
      similarUsers: IUser[] = []; â† Remove this
      user$: Observable<IUser> = null; â† Add this
     similarUsers$: Observable<IUser[]> = null; â† Add this
      isComponentAlive: boolean;
      constructor( ) {}
      ngOnInit() {
        this.isComponentAlive = true;
      }
      ngOnDestroy() {
        this.isComponentAlive = false;
      }
    }
    ```

4.  æ›´æ–°`user-detail.component.html`æ¨¡æ¿ä»¥ä½¿ç”¨æ–°çš„å¯è§‚å¯Ÿå±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    <div class="user-detail">
      <div class="main-content user-card">
        <app-user-card *ngIf="user$ | async as user;     else loader" [user]="user"></app-user-card>
      </div>
      <div class="secondary-container">
        <h4>Similar Users</h4>
        <div class="similar-users">
          <ng-container *ngIf="similarUsers$ | async       as similarUsers; else loader">
            <app-user-card class="user-card" *ngFor="let user         of similarUsers" [user]="user"></app-user-card>
          </ng-container>
        </div>
      </div>
    </div>
    ...
    ```

5.  Update the `app.selectors.ts` file to add both the selectors, as follows:

    ```ts
    ...
    import { IUser } from '../core/interfaces/user.interface';
    export const selectUsers = createSelector(...);
    export const selectCurrentUser = (uuid) => createSelector(
     selectUsers,
     (users: IUser[]) => users ? users.find(user => {
     return user.login.uuid === uuid;
     }) : null
    );
    export const selectSimilarUsers = (uuid) => createSelector(
     selectUsers,
     (users: IUser[]) => users ? users.filter(user => {
     return user.login.uuid !== uuid;
     }): null
    );
    ```

    ç”±äºæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·çš„**é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦**ï¼ˆ**UUID**ï¼‰å¯¼èˆªåˆ°**ç”¨æˆ·è¯¦ç»†ä¿¡æ¯**é¡µé¢ï¼Œæˆ‘ä»¬å°†ç›‘å¬æ´»åŠ¨è·¯ç”±çš„`paramsMap`å¹¶åˆ†é…é€‚å½“çš„é€‰æ‹©å™¨ã€‚

6.  é¦–å…ˆï¼Œå°†æ­£ç¡®çš„å¯¼å…¥æ·»åŠ åˆ°`user-detail.component.ts`æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    import { takeWhile } from 'rxjs/operators';
    import { Store } from '@ngrx/store';
    import { AppState } from '../store/app.reducer';
    import { selectCurrentUser, selectSimilarUsers } from '../store/app.selectors';
    import { ActivatedRoute } from '@angular/router';
    ```

7.  Now, in the same `user-detail.component.ts` file, use the `Store` service and update the `ngOnInit` method, as follows:

    ```ts
    @Component({...})
    export class UserDetailComponent implements OnInit, OnDestroy {
      ...
      constructor(
        private route: ActivatedRoute,
     private store: Store<AppState>
      ) {}
      ngOnInit() {
        this.isComponentAlive = true;
        this.route.paramMap.pipe(
     takeWhile(() => !!this.isComponentAlive)
     )
     .subscribe(params => {
     const uuid = params.get('uuid');
     this.user$ = this.store.      select(selectCurrentUser(uuid))
     this.similarUsers$ = this.store.      select(selectSimilarUsers(uuid))
     });
      }
      ...
    }
    ```

    æˆ‘ä»¬å°†åœ¨`UserDetailComponent`ç±»ä¸­æ·»åŠ å¦ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æœç”¨æˆ·å°šæœªåœ¨åº”ç”¨ç¨‹åºä¸­è·å–ï¼Œè¯¥æ–¹æ³•å°†è·å–ç”¨æˆ·ã€‚

8.  å°†`getUsersIfNecessary`æ–¹æ³•æ·»åŠ åˆ°`user-detail.component.ts`æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    import { first, takeWhile } from 'rxjs/operators';
    import { Store } from '@ngrx/store';
    import { AppState } from '../store/app.reducer';
    import { selectCurrentUser, selectSimilarUsers, selectUsers } from '../store/app.selectors';
    import { getUsers } from '../store/app.actions';
    @Component({...})
    export class UserDetailComponent implements OnInit, OnDestroy {
      ...
      ngOnInit() {
        â€¦
        this.getUsersIfNecessary();
      }
      getUsersIfNecessary() {
     this.store.select(selectUsers)
     .pipe(
     first ()
     )
     .subscribe((users) => {
     if (users === null) {
     this.store.dispatch(getUsers())
     }
     })
     }
    }
    ```

åˆ·æ–°åº”ç”¨ç¨‹åºâ€¦ç„¶åç °çš„ä¸€å£°ï¼æ‚¨ç°åœ¨å¯ä»¥çœ‹åˆ°å½“å‰çš„ç”¨æˆ·ä»¥åŠç±»ä¼¼çš„ç”¨æˆ·ã€‚è¯·å‚é˜…ä¸‹ä¸€èŠ‚ä»¥äº†è§£å…¶å·¥ä½œåŸç†ã€‚

## å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„â€¦

åœ¨è¿™ä¸ªé…æ–¹ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª reducer å’Œä¸€ä¸ªä½œä¸ºç”¨æˆ·è·å–ç¬¬ä¸‰æ–¹ API æ•°æ®çš„æ•ˆæœã€‚æˆ‘ä»¬é¦–å…ˆä¸ºä¸»å±å¹•çš„ç”¨æˆ·åˆ›å»ºä¸€ä¸ªé€‰æ‹©å™¨ã€‚è¿™å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„é€‰æ‹©å™¨ã€‚è¯·æ³¨æ„ï¼Œå‡é€Ÿå™¨çš„çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š

```ts
  app: {
    users: []
  }
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é¦–å…ˆä½¿ç”¨`createFeatureSelector`è·å–`app`çŠ¶æ€ï¼Œç„¶åä½¿ç”¨`createSelector`è·å–`users`çŠ¶æ€ã€‚

å›°éš¾çš„éƒ¨åˆ†æ˜¯è·å–å½“å‰ç”¨æˆ·å’Œç±»ä¼¼ç”¨æˆ·ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å¯ä»¥å°†`uuid`ä½œä¸ºè¾“å…¥çš„é€‰æ‹©å™¨ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨`UserDetailComponent`è¯¾ä¸Šå¬äº†`uuid`çš„`paramMap`ï¼Œä¸€æ—¦å®ƒå˜äº†ï¼Œæˆ‘ä»¬å°±æŠŠå®ƒå–äº†å‡ºæ¥ã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡å°†`uuid`ä¼ é€’ç»™é€‰æ‹©å™¨ï¼Œå°†å…¶ä¸é€‰æ‹©å™¨ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿é€‰æ‹©å™¨å¯ä»¥è¿‡æ»¤å½“å‰ç”¨æˆ·å’Œç±»ä¼¼ç”¨æˆ·ã€‚

æœ€åï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæœ‰äººç›´æ¥ç™»å½•åˆ°å¸¦æœ‰`uuid`çš„**ç”¨æˆ·è¯¦ç»†ä¿¡æ¯**é¡µé¢ï¼Œä»–ä»¬å°†çœ‹ä¸åˆ°ä»»ä½•å†…å®¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ä¼šè·å–ç”¨æˆ·ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åªåœ¨ä¸»é¡µä¸Šè·å–ç”¨æˆ·ï¼Œå› æ­¤ä»»ä½•ç›´æ¥ç™»å½•åˆ°ç”¨æˆ·è¯¦ç»†ä¿¡æ¯é¡µé¢çš„äººéƒ½ä¸ä¼šè§¦å‘æ•ˆæœã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`getUsersIfNecessary`çš„æ–¹æ³•ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥æ£€æŸ¥çŠ¶æ€ï¼Œå¹¶åœ¨å°šæœªè·å–ç”¨æˆ·çš„æƒ…å†µä¸‹è·å–ç”¨æˆ·ã€‚

## å¦è§

*   NgRx é€‰æ‹©å™¨æ–‡æ¡£ï¼ˆ[https://ngrx.io/guide/store/selectors](https://ngrx.io/guide/store/selectors)

# ä½¿ç”¨@ngrx/ç»„ä»¶å­˜å‚¨è¿›è¡Œç»„ä»¶å†…çš„æœ¬åœ°çŠ¶æ€ç®¡ç†

åœ¨æœ¬é…æ–¹ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ NgRx ç»„ä»¶å­˜å‚¨ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒæ¥ä»£æ›¿åŸºäºæ¨é€çš„ Subject/Behavior Subject æ¨¡å¼ï¼Œå¹¶ä½¿ç”¨æœåŠ¡åœ¨æœ¬åœ°ç»´æŠ¤ç»„ä»¶çš„çŠ¶æ€ã€‚

è¯·è®°ä½ï¼Œ`@ngrx/component-store`æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº“ï¼Œä¸`Redux`æˆ–`@ngrx/store`ç­‰æ— å…³ã€‚

## å‡†å¤‡å¥½äº†å—

æˆ‘ä»¬å°†è¦å¤„ç†çš„é¡¹ç›®ä½äº`chapter06/start_here/ngrx-component-store`ä¸­ï¼Œä½äºå…‹éš†çš„å¯„å­˜å™¨å†…ï¼š

1.  åœ¨ VS ä»£ç ä¸­æ‰“å¼€é¡¹ç›®ã€‚
2.  æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œ`npm install`å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
3.  å®Œæˆåï¼Œè¿è¡Œ`ng serve -o`ã€‚

è¿™å°†åœ¨æ–°çš„æµè§ˆå™¨é€‰é¡¹å¡ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºã€‚ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ï¼Œæ‚¨å°†çœ‹åˆ°å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![Figure 6.18 â€“ ngrx-component-store app running on http://localhost:4200 ](img/Figure_6.18_B15150.jpg)

å›¾ 6.18â€“è¿è¡Œåœ¨ä¸Šçš„ ngrx ç»„ä»¶å•†åº—åº”ç”¨ç¨‹åº http://localhost:4200

ç°åœ¨æˆ‘ä»¬å·²ç»åœ¨æœ¬åœ°è¿è¡Œäº†åº”ç”¨ç¨‹åºï¼Œè®©æˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚ä¸­æŸ¥çœ‹é…æ–¹çš„æ­¥éª¤ã€‚

## æ€ä¹ˆåšâ€¦

æˆ‘ä»¬æœ‰æˆ‘ä»¬æœ€å–œæ¬¢çš„ bucket åº”ç”¨ç¨‹åºï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»åœ¨å¾ˆå¤šé£Ÿè°±ä¸­ä½¿ç”¨è¿‡ã€‚å½“å‰æ¡¶çš„çŠ¶æ€å­˜å‚¨åœ¨ä½¿ç”¨`BehaviorSubject`æ¨¡å¼çš„`BucketService`ä¸­ã€‚æˆ‘ä»¬å°†ç”¨ NgRx ç»„ä»¶å•†åº—å–ä»£å®ƒã€‚å¼€å§‹å§ï¼š

1.  é€šè¿‡åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†`@ngrx/component-store`åŒ…æ·»åŠ åˆ°é¡¹ç›®çš„ä¾èµ–é¡¹ä¸­ï¼š

    ```ts
    npm install @ngrx/component-store@12.0.0 --save
    ```

2.  We first have to make our `BucketService` compatible with a `ComponentStore`. In order to do that, we'll create an interface for the bucket state, extend the `BucketService` from `ComponentStore`, and initialize the service by calling the `super` method. Update the `file services/bucket.service.ts` file, as follows:

    ```ts
    ...
    import { IBucketService } from '../interfaces/bucket-service';
    import { ComponentStore } from '@ngrx/component-store';
    export interface BucketState {
     bucket: IFruit[]
    }
    @Injectable({
      providedIn: 'root'
    })
    export class BucketService extends ComponentStore<BucketState>  implements IBucketService {
      bucketSource = new BehaviorSubject([]);
      bucket$: Observable<IFruit[]> =   this.bucketSource.asObservable();
      constructor() {
        super({
     bucket: []
     })
      }
      ...
    }
    ```

    åœ¨æˆ‘ä»¬å®é™…æ˜¾ç¤ºæ¥è‡ª`ComponentStore`çš„æ•°æ®ä¹‹å‰ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ²¡æœ‰æ„ä¹‰ã€‚è®©æˆ‘ä»¬ç°åœ¨å°±å¼€å§‹å§ã€‚

3.  Modify the `bucket$` Observable to use the `ComponentStore` state rather than relying on the `BehaviorSubject` pattern, as follows:

    ```ts
    ...
    export class BucketService extends ComponentStore<BucketState>  implements IBucketService {
      bucketSource = new BehaviorSubject([]);
     readonly bucket$: Observable<IFruit[]> =   this.select(state => state.bucket);
      constructor() {
        super({
          bucket: []
        })
      }
      ...
    }
    ```

    æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ï¼Œæ‰€æœ‰çš„ bucket é¡¹éƒ½ä¸å†æ˜¾ç¤ºï¼Œæˆ–è€…å³ä½¿æ‚¨æ·»åŠ äº†ä¸€ä¸ªé¡¹ï¼Œå®ƒä¹Ÿä¸ä¼šæ˜¾ç¤ºã€‚é‚£æ˜¯å› ä¸ºå®ƒä»ç„¶éœ€è¦ä¸€äº›å·¥ä½œã€‚

4.  First, let's make sure that instead of initializing the `bucket` from the Component Store with an empty array, we initialize it with the values from `localStorage`. Just try adding a few items, even if they don't show up yet. Then, modify the `loadItems()` method to use the `setState` method on `BucketService`. The code should look like this:

    ```ts
      loadItems() {
        const bucket = JSON.parse(window.localStorage.    getItem('bucket') || '[]');
        this.bucketSource.next(bucket); â† Remove this
        this.setState({ â† Add this
     bucket
     })
      }
    ```

    è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å·²ç»ä»ä»£ç ä¸­åˆ é™¤äº†`this.bucketSource.next(bucket);`è¡Œã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¸å†ä½¿ç”¨`bucketSource`å±æ€§ï¼Œè¿™æ˜¯ä¸€ç§`BehaviorSubject`æ¨¡å¼ã€‚æˆ‘ä»¬å°†å¯¹ä¸‹ä¸€ç»„å‡½æ•°æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚

    æ­¤å¤–ï¼Œæ‚¨ç°åœ¨åº”è¯¥å¯ä»¥çœ‹åˆ°ä»¥å‰æ·»åŠ ä½†æœªæ˜¾ç¤ºçš„é¡¹ç›®ã€‚

5.  Let's replace the `addItem` method in the `BucketService` now so that it updates the state correctly and shows the new items on view, as intended. For this, we'll use the `updater` method of the `ComponentStore` and modify our `addItem` method to be an updater, as follows:

    ```ts
      readonly addItem = this.updater((state, fruit: IFruit)   => {
     const bucket = [fruit, ...state.bucket]
     window.localStorage.setItem('bucket',     JSON.stringify(bucket));
     return ({
     bucket
     })
     });
    ```

    å¦‚æœæ‚¨ç°åœ¨æ·»åŠ ä¸€ä¸ªé¡¹ç›®ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°å®ƒå‡ºç°åœ¨è§†å›¾ä¸Šã€‚

6.  We can now replace the `removeItem` method as well to be an `updater` method in the `BucketService` as well. The code should look like this:

    ```ts
      readonly removeItem = this.updater((state, fruit:   IFruit) => {
     const bucket = state.bucket.filter(item =>     item.id !== fruit.id);
     window.localStorage.setItem('bucket',     JSON.stringify(bucket));
     return ({
     bucket
     })
     });
    ```

    é€šè¿‡æ­¤æ›´æ”¹ï¼Œæ‚¨åº”è¯¥å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬ç¡®å®æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œé‚£å°±æ˜¯`EmployeeService`ä¹Ÿéœ€è¦æ›´æ–°ï¼Œä»¥ä½¿`removeItem`æ–¹æ³•æˆä¸º`updater`æ–¹æ³•ã€‚

7.  Let's replace the `removeItem` method in the `EmployeeBucketService` to be an `updater` method as well. Modify the `employee/services/employee-bucket.service.ts` file, as follows:

    ```ts
    import { Injectable } from '@angular/core';
    import { IFruit } from 'src/app/interfaces/fruit.interface';
    import { BucketService } from 'src/app/services/bucket.service';
    ...
    export class EmployeeBucketService extends BucketService {
      constructor() {
        super();
      }
      readonly removeItem = this.updater((state, _: IFruit)   => {
     alert('Employees can not delete items');
     return state;
     });
    }
    ```

    ç§ï¼å®é™…ä¸Šï¼Œç°åœ¨ä¸€åˆ‡éƒ½åº”è¯¥å¾ˆå¥½ï¼Œè€Œä¸”ä½ ä¸åº”è¯¥çœ‹åˆ°ä»»ä½•é”™è¯¯ã€‚

8.  æ—¢ç„¶æˆ‘ä»¬å·²ç»å»æ‰äº†åä¸º`bucketSource`çš„`BucketService`å±æ€§ä¸­`BehaviorSubject`æ¨¡å¼çš„æ‰€æœ‰ç”¨æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä»`BucketService`ä¸­åˆ é™¤è¯¥å±æ€§æœ¬èº«ã€‚æœ€åçš„ä»£ç åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    import { Injectable } from '@angular/core';
    import { BehaviorSubject â† Remove this, Observable } from 'rxjs';
    ...
    export class BucketService extends ComponentStore<BucketState>  implements IBucketService {
     bucketSource = new BehaviorSubject([]); â† Remove
      readonly bucket$: Observable<IFruit[]> =   this.select((state) => state.bucket);
      constructor() {
        super({
          bucket: []
        })
      }
    ...
    }
    ```

ç¥è´ºä½ å®Œæˆäº†é£Ÿè°±ã€‚è¯·å‚é˜…ä¸‹ä¸€èŠ‚ä»¥äº†è§£å…¶å·¥ä½œåŸç†ã€‚

## å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„â€¦

å¦‚å‰æ‰€è¿°ï¼Œ`@ngrx/component-store`æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è½¯ä»¶åŒ…ï¼Œå¯ä»¥è½»æ¾åœ°å®‰è£…åœ¨æ‚¨çš„ Angularåº”ç”¨ç¨‹åºä¸­ï¼Œè€Œæ— éœ€ä½¿ç”¨`@ngrx/store`ã€`@ngrx/effects`ç­‰ã€‚å®ƒåº”è¯¥å–ä»£`BehaviorSubject`åœ¨è§’åº¦æœåŠ¡ä¸­çš„ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªé…æ–¹ä¸­æ‰€åšçš„ã€‚æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ª`ComponentStore`ä»¥åŠå¦‚ä½•åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†å€¼è€Œæ²¡æœ‰è®¿é—®çŠ¶æ€æ—¶ä½¿ç”¨`setState`æ–¹æ³•è®¾ç½®åˆå§‹çŠ¶æ€ï¼Œæˆ‘ä»¬è¿˜å­¦ä¹ äº†å¦‚ä½•åˆ›å»º`updater`æ–¹æ³•æ¥æ›´æ–°çŠ¶æ€ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è®¿é—®çŠ¶æ€ï¼Œç”šè‡³å…è®¸æˆ‘ä»¬ä¸ºè‡ªå·±çš„ç”¨ä¾‹ä¼ é€’å‚æ•°ã€‚

## å¦è§

*   `@ngrx/component-store`æ–‡ä»¶[https://ngrx.io/guide/component-store](https://ngrx.io/guide/component-store)
*   `@ngrx/component-store`æ–‡ä»¶ï¼ˆ[ä¸­çš„æ•ˆæœ https://ngrx.io/guide/component-store/effect](https://ngrx.io/guide/component-store/effect)

# ä½¿ç”¨@ngrx/è·¯ç”±å­˜å‚¨å¯¹è·¯ç”±æ›´æ”¹è¿›è¡Œååº”æ€§å¤„ç†

NgRx éå¸¸æ£’ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨å°†æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªé›†ä¸­çš„åœ°æ–¹ã€‚ç„¶è€Œï¼Œæ”¶å¬è·¯çº¿å˜åŒ–ä»ç„¶è¶…å‡ºäº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€è®¨è®ºçš„ NgRx èŒƒå›´ã€‚æˆ‘ä»¬ç¡®å®ä¾èµ–`ActivatedRoute`æœåŠ¡æ¥è§‚å¯Ÿè·¯ç”±çš„å˜åŒ–ï¼Œå½“æˆ‘ä»¬æƒ³è¦æµ‹è¯•è¿™äº›ç»„ä»¶æ—¶ï¼Œ`ActivatedRoute`æœåŠ¡å°±å˜æˆäº†ä¸€ä¸ªä¾èµ–é¡¹ã€‚åœ¨æ­¤é…æ–¹ä¸­ï¼Œæ‚¨å°†å®‰è£…`@ngrx/router-store`åŒ…ï¼Œå¹¶å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨åŒ…ä¸­å†…ç½®çš„ä¸€äº›æ“ä½œæ¥ä¾¦å¬è·¯ç”±æ›´æ”¹ã€‚

## å‡†å¤‡å¥½äº†å—

æˆ‘ä»¬å°†ä¸åˆä½œçš„é¡¹ç›®ä½äº`chapter06/start_here/ngrx-router-store`ä¸­ï¼Œä½äºå…‹éš†çš„å¯„å­˜å™¨å†…ï¼š

1.  åœ¨ VS ä»£ç ä¸­æ‰“å¼€é¡¹ç›®ã€‚
2.  æ‰“å¼€ç»ˆç«¯å¹¶è¿è¡Œ`npm install`æ¥å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
3.  Once done, run `ng serve -o`.

    è¿™å°†åœ¨æ–°çš„æµè§ˆå™¨é€‰é¡¹å¡ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š

![Figure 6.19 â€“ ngrx-router-store app running on http://localhost:4200 ](img/Figure_6.19_B15150.jpg)

å›¾ 6.19â€“åœ¨ä¸Šè¿è¡Œçš„ ngrx è·¯ç”±å•†åº—åº”ç”¨ç¨‹åº http://localhost:4200

ç°åœ¨åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œè¯·å‚é˜…ä¸‹ä¸€èŠ‚äº†è§£é…æ–¹çš„æ­¥éª¤ã€‚

## æ€ä¹ˆåšâ€¦

ä¸ºäº†åˆ©ç”¨ NgRxçš„åŠŸç‡ï¼Œç”šè‡³ç”¨äºè·¯ç”±å˜æ›´ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨`@ngrx/router-store`åŒ…æ¥ç›‘å¬è·¯ç”±å˜æ›´ã€‚å¼€å§‹å§ï¼

1.  é¦–å…ˆï¼Œé€šè¿‡åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…`@ngrx/router-store`åŒ…ï¼š

    ```ts
    npm install @ngrx/router-store@12.0.0 --save
    ```

2.  Now, import `StoreRouterConnectingModule` and `routerReducer` from the `@ngrx/router-store` package in your `app.module.ts` file and set up the `imports`, as follows:

    ```ts
    ...
    import { StoreRouterConnectingModule, routerReducer } from '@ngrx/router-store';
    @NgModule({
      declarations: [...],
      imports: [
        BrowserModule,
        AppRoutingModule,
        HttpClientModule,
        StoreModule.forRoot({
          app: appStore.reducer,
     router: routerReducer
        }),
     StoreRouterConnectingModule.forRoot(),
        StoreDevtoolsModule.instrument({
          maxAge: 25, // Retains last 25 states
        }),
        EffectsModule.forRoot([AppEffects])
      ],
      providers: [],
      bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

    ä¸€æ—¦æ‚¨ç°åœ¨åˆ·æ–°åº”ç”¨ç¨‹åºå¹¶é€šè¿‡ Redux DevTools æ‰©å±•å¯¹å…¶è¿›è¡Œæ£€æŸ¥ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€äº›åä¸º`@ngrx/router-store/*`çš„é™„åŠ æ“ä½œä¹Ÿè¢«è°ƒåº¦ã€‚æ‚¨è¿˜åº”è¯¥çœ‹åˆ°çŠ¶æ€ä¸­çš„`router`å±æ€§åŒ…å«å½“å‰è·¯ç”±çš„ä¿¡æ¯ï¼Œå¦‚ä»¥ä¸‹å±å¹•æˆªå›¾æ‰€ç¤ºï¼š

    ![Figure 6.20 â€“ @ngrx/router-store actions and the router state reflected in the NgRx store ](img/Figure_6.20_B15150.jpg)

    å›¾ 6.20â€“@ngrx/è·¯ç”±å­˜å‚¨æ“ä½œå’Œ ngrx å­˜å‚¨ä¸­åæ˜ çš„è·¯ç”±çŠ¶æ€

3.  æˆ‘ä»¬ç°åœ¨å¿…é¡»ä¿®æ”¹æˆ‘ä»¬çš„ reducerï¼Œæˆ–è€…æ›´å‡†ç¡®åœ°è¯´ï¼Œä¿®æ”¹`AppState`æ¥å£ï¼Œä»¥åæ˜ æˆ‘ä»¬ä¹Ÿæ‹¥æœ‰`@ngrx/router-store`åŒ…ä¸­çš„`router`å±æ€§ã€‚ä¸ºæ­¤ï¼Œä¿®æ”¹`store/app.reducer.ts`æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    import { getUsersSuccess } from './app.actions';
    import { RouterReducerState } from '@ngrx/router-store'
    export interface AppState {
      users: IUser[];
     router: RouterReducerState<any>;
    }
    const initialState: AppState = {
      users: null,
     router: null
    }
    ...
    ```

4.  Essentially, we have to get rid of the `ActivatedRoute` service's usage from our `UserDetailComponent` class. In order to do so, we'll first modify our selectors to get the params from the router state directly. Modify the `app.selectors.ts` file, as follows:

    ```ts
    ...
    import { getSelectors, RouterReducerState } from '@ngrx/router-store';
    export const selectApp = createFeatureSelector<AppState>('app');
    export const selectUsers = createSelector(
      selectApp,
      (state: AppState) => state.users
    );
    ...
    export const selectRouter = createFeatureSelector<
     AppState,
     RouterReducerState<any>
    >('router');
    const { selectRouteParam } = getSelectors(selectRouter);
    export const selectUserUUID = selectRouteParam('uuid');
    export const selectCurrentUser = createSelector(
     selectUserUUID,
     selectUsers,
     (uuid, users: IUser[]) => users ? users.find(user => {
     return user.login.uuid === uuid;
     }) : null
    );
    export const selectSimilarUsers = createSelector(
     selectUserUUID,
     selectUsers,
     (uuid, users: IUser[]) => users ? users.filter(user =>   {
     return user.login.uuid !== uuid;
     }): null
    );
    ```

    æ‚¨ç°åœ¨åº”è¯¥å¯ä»¥åœ¨æ§åˆ¶å°ä¸Šçœ‹åˆ°ä¸€äº›é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ›´æ”¹äº†`selectSimilarUsers`å’Œ`selectCurrentUser`é€‰æ‹©å™¨çš„ç­¾åï¼Œä½†å®ƒå°†åœ¨ä¸‹ä¸€æ­¥ä¿®å¤ã€‚

5.  Modify the `user-detail/user-detail.component.ts` file to use the updated selectors correctly, as follows:

    ```ts
    ...
    export class UserDetailComponent implements OnInit, OnDestroy {
      ...
      ngOnInit() {
        ...
        this.route.paramMap.pipe(
          takeWhile(() => !!this.isComponentAlive)
        )
        .subscribe(params => {
          const uuid = params.get('uuid');
          this.user$ = this.store.select(selectCurrentUser)
          this.similarUsers$ = this.store.      select(selectSimilarUsers)
        })
      }
      ...
    }
    ```

    è¿™ä¸ªæ›´æ”¹åº”è¯¥å·²ç»è§£å†³äº†æ§åˆ¶å°ä¸Šçš„é”™è¯¯ï¼Œå¹¶ä¸”ä½ åº”è¯¥çœ‹åˆ°åº”ç”¨ç¨‹åºåœ¨ä¸Šè¿è¡Œå¾—éå¸¸å¥½ï¼Œå³ä½¿æˆ‘ä»¬ä¸å†ä»`UserDetailComponent`ç±»ä¼ é€’ä»»ä½•`uuid`ã€‚

6.  é€šè¿‡ä¸Šä¸€æ­¥çš„ä¿®æ”¹ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä»`UserDetailComponent`ç±»ä¸­åˆ é™¤`ActivatedRoute`æœåŠ¡çš„ä½¿ç”¨ï¼Œä»£ç åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

    ```ts
    ...
    import { Observable } from 'rxjs/internal/Observable';
    import { first } from 'rxjs/operators';
    import { Store } from '@ngrx/store';
    ...
    export class UserDetailComponent implements OnInit, OnDestroy {
      ...
      constructor(
     private store: Store<AppState>
    ) {}
      ngOnInit() {
        this.isComponentAlive = true;
        this.getUsersIfNecessary();
        this.user$ = this.store.select(selectCurrentUser)
     this.similarUsers$ = this.store.    select(selectSimilarUsers)
      }
      ...
    }
    ```

å‘œå‘¼ï¼ä½ ç°åœ¨å·²ç»å®Œæˆäº†é£Ÿè°±ã€‚è¯·å‚é˜…ä¸‹ä¸€èŠ‚äº†è§£å…¶å·¥ä½œåŸç†ã€‚

## å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„â€¦

`@ngrx/router-store`æ˜¯ä¸€ä¸ªç¥å¥‡çš„è½¯ä»¶åŒ…ï¼Œå®ƒé€šè¿‡ NgRx è®©æˆ‘ä»¬çš„å¼€å‘å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ‚¨çœ‹åˆ°äº†æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨åŒ…ä¸­çš„é€‰æ‹©å™¨å°†`ActivatedRoute`æœåŠ¡ä»`UserDetailComponent`ç±»ä¸­å®Œå…¨åˆ é™¤ã€‚æœ¬è´¨ä¸Šï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬åœ¨é€‰æ‹©å™¨ä¸­è·å¾—æ­£ç¡®çš„**è·¯ç”±å‚æ•°**ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é€‰æ‹©å™¨ä¸­ä½¿ç”¨å®ƒæ¥è·å–å’Œè¿‡æ»¤é€‚å½“çš„æ•°æ®ã€‚åœ¨åœºæ™¯èƒŒåï¼Œè½¯ä»¶åŒ…ç›‘å¬æ•´ä¸ª Angular åº”ç”¨ç¨‹åºä¸­çš„è·¯ç”±å˜åŒ–ï¼Œå¹¶ä»è·¯ç”±æœ¬èº«è·å–ã€‚ç„¶åï¼Œå®ƒå°†ç›¸åº”çš„ä¿¡æ¯å­˜å‚¨åœ¨ NgRx å­˜å‚¨ä¸­ï¼Œä½¿å…¶ä¿æŒåœ¨ Redux çŠ¶æ€ï¼Œå¹¶å¯é€šè¿‡è½¯ä»¶åŒ…æä¾›çš„é€‰æ‹©å™¨è½»æ¾é€‰æ‹©ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™å¤ªå¯æ€•äº†ï¼æˆ‘ä¹‹æ‰€ä»¥è¿™æ ·è¯´ï¼Œæ˜¯å› ä¸ºè¯¥ä¸€æ½å­è®¡åˆ’æ­£åœ¨å®Œæˆæˆ‘ä»¬å¿…é¡»å®Œæˆçš„æ‰€æœ‰ç¹é‡å·¥ä½œã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„`UserDetailComponent`ç±»ç°åœ¨åªä¾èµ–`Store`æœåŠ¡ï¼Œè¿™ä½¿å¾—æµ‹è¯•æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºä¾èµ–æ€§æ›´å°‘ã€‚

## å¦è§

*   `@ngrx/router-store`æ–‡ä»¶[https://ngrx.io/guide/router-store/](https://ngrx.io/guide/router-store/)